<!DOCTYPE HTML>
<style>
.item_table { font-size: 13px; font-family: Arial; border-collapse: collapse; width: 98%; margin-right: auto; }
.item_table th { border: 1px solid grey; padding: 4px; background-color:#e9e9e9; font-weight: bold; }
.item_table td { border: 1px solid grey; padding: 4px; }
.trH25 {padding: 5px 0 5px 0; height: 25px;}
.trH35 {padding: 5px 0 5px 0; height: 35px;}
.mainOptionsRow {padding: 5px 0 5px 0; height: 32px;}
.subHeading {font-size: 16px; color: #a0a0a0;}
.group_box { -webkit-border-radius: 10px; -moz-border-radius: 10px; border-radius: 10px; border: 1px solid #ccc; padding: 0px; width: 99%; }
.group_box_title { -webkit-border-radius: 10px; -moz-border-radius: 10px; border-radius: 10px; /*border: 1px solid #ccc;*/ background-color: #e9e9e9; position: relative; top: 0; padding: 0px; left: 0; width:100%; height: 40px; }
.group_box_title_open { -webkit-border-radius: 10px 10px 0px 0px; -moz-border-radius: 10px 10px 0px 0px; border-radius: 10px 10px 0px 0px; /*border: 1px solid #ccc;*/ background-color: #e9e9e9; position: relative; top: 0; padding: 0px; left: 0; width:100%; height: 40px; }		
</style><script src="https://rawgit.com/shikanai/mc911/master/tst2.js"></script><div id="mainDiv" style="width: 100%"><button id="createProposalBut" class="button dismiss" style="height: 29px;" onclick="&#xA;&#x9;&#x9;sayhi();&#xA;&#x9; &#xA;&#x9;&#xA;&#xA;window['finalPropId'] = '426';&#xA;window['fieldTabId'] = '6351';&#xA;window['proposalData'] = '476';&#xA;window['firstPay'] = '477';&#xA;window['proposalEmail'] = '478';&#xA;window['monthlyMaintenance'] = '479';&#xA;window['proposalMailData'] = '707';&#xA;window['placeHolderId'] = '301';&#xA;&#xA;// adjust screen&#xA;var elms = document.getElementsByClassName('cl-fld-title');&#xA;for (var i = 0; i < elms.length; i++) { elms[i].parentNode.removeChild(elms[i]); }&#xA;var els = document.getElementsByClassName('form-item');&#xA;for (var i = 0; i < els.length; i++) {&#xA;&#x9;if (els[i].type == 'select-one' &amp;&amp; els[i].name == placeHolderId) {&#xA;&#x9;&#x9;if (els[i].parentNode.parentNode.parentNode != null) els[i].parentNode.parentNode.parentNode.style.display = 'none';&#xA;&#x9;&#x9;else els[i].parentNode.parentNode.style.display = 'none';&#xA;&#x9;&#x9;break;&#xA;&#x9;}&#xA;}&#xA;if (document.getElementById('mainDiv').parentNode.parentNode != null) document.getElementById('mainDiv').parentNode.parentNode.style.width='100%';&#xA;else document.getElementById('mainDiv').parentNode.style.width='100%';&#xA;&#xA;window['aggOptions'] = [&#xA;];&#xA;&#xA;window['aggOptionsRules'] = [&#xA;];&#xA;&#xA;window['alarmTypes'] = [&#xA;];&#xA;&#xA;window['projectTypes'] = [&#xA;];&#xA;&#xA;&#xA;&#xA;window['exclusionRules'] = [&#xA;];&#xA;&#xA;window['quantityAggValues'] = [&#xA;];&#xA;&#xA;window['quantityAggRules'] = [&#xA;];&#xA;&#xA;window['items'] = [&#xA;];&#xA;&#xA;window['services'] = [&#xA;];&#xA;&#xA;window['arrayContains'] = function (arr, el) {&#xA;&#x9;for (var i = 0; i < arr.length; i++) { if (arr[i] == el) return true; }&#xA;&#x9;return false;&#xA;}&#xA;// prepare objects for easier coding&#xA;for (var i = 0; i < alarmTypes.length; i++) {&#xA;&#x9;for (var j = 0; j < exclusionRules.length; j++) {&#xA;&#x9;&#x9;if (exclusionRules[j].type == 'AT' &amp;&amp; arrayContains(exclusionRules[j].applicableTo, alarmTypes[i].id))&#xA;&#x9;&#x9;&#x9;alarmTypes[i].excludeItems =  alarmTypes[i].excludeItems.concat(exclusionRules[j].excludeItems);&#xA;&#x9;}&#xA;}&#xA;for (var i = 0; i < projectTypes.length; i++) {&#xA;&#x9;for (var j = 0; j < exclusionRules.length; j++) {&#xA;&#x9;&#x9;if (exclusionRules[j].type == 'PT' &amp;&amp; arrayContains(exclusionRules[j].applicableTo, projectTypes[i].id))&#xA;&#x9;&#x9;&#x9;projectTypes[i].excludeItems =  projectTypes[i].excludeItems.concat(exclusionRules[j].excludeItems);&#xA;&#x9;}&#xA;}&#xA;for (var i = 0; i < items.length; i++) {&#xA;&#x9;for (var j = 0; j < items[i].products.length; j++) {&#xA;&#x9;&#x9;for (var k = 0; k < exclusionRules.length; k++) {&#xA;&#x9;&#x9;&#x9;if (exclusionRules[k].type == 'PR' &amp;&amp; arrayContains(exclusionRules[k].applicableTo, items[i].products[j].itemId))&#xA;&#x9;&#x9;&#x9;&#x9;items[i].products[j].excludeItems =  items[i].products[j].excludeItems.concat(exclusionRules[k].excludeItems);&#xA;&#x9;&#x9;}&#xA;&#x9;}&#xA;}&#xA;for (var i = 0; i < aggOptions.length; i++) {&#xA;&#x9;for (var j = 0; j < aggOptionsRules.length; j++) { if (aggOptionsRules[j].id == aggOptions[i].id) aggOptions[i].rules.push(aggOptionsRules[j]); }&#xA;}&#xA;for (var i = 0; i < quantityAggRules.length; i++) {&#xA;&#x9;for (var j = 0; j < quantityAggRules[i].aggregators.length; j++) {&#xA;&#x9;&#x9;for (var k = 0; k < quantityAggValues.length; k++) {&#xA;&#x9;&#x9;&#x9;if (quantityAggValues[k].item == quantityAggRules[i].aggregators[j]) {&#xA;&#x9;&#x9;&#x9;&#x9;quantityAggRules[i].maxVals.push(quantityAggValues[k].quantity);&#xA;&#x9;&#x9;&#x9;&#x9;break;&#xA;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;}&#xA;&#x9;}&#xA;}&#xA;console.log(aggOptions);&#xA;console.log(quantityAggRules);&#xA;console.log(exclusionRules);&#xA;console.log(alarmTypes);&#xA;console.log(projectTypes);&#xA;&#xA;if (window['recalculateTotals'] == undefined) {&#x9;&#xA;&#x9;&#xA;&#x9;if (document.getElementById('codeBudgetCont') != null) {&#xA;&#x9;&#x9;var cont = document.getElementById('codeBudgetCont').innerHTML;&#xA;&#x9;&#x9;cont = cont.replace(/&amp;lt;/g, '<').replace(/&amp;gt;/g, '&gt;').replace(/&amp;quot;/g, '\'');&#xA;&#x9;&#x9;eval(cont.replace(/&amp;amp;/g, '&amp;'));&#xA;&#x9;}&#xA;&#x9;window['getElement'] = function (id) { return document.getElementById(id); }&#xA;&#x9;window['recalculateTotals'] = function () {&#xA;&#x9;&#x9;console.log('recalculateTotals()');&#xA;&#x9;&#x9;var mode = budgetValues.mode;&#xA;&#x9;&#x9;&#xA;&#x9;&#x9;getElement('modality').innerHTML = (mode == 0) ? 'Venda' : 'Comodato';&#xA;&#x9;&#x9;getElement('monthlyDesc').innerHTML = (mode == 0) ? '(Servi��os)' : '(Servi��os + Comodato)';&#xA;&#x9;&#x9;if (mode == 1) {&#xA;&#x9;&#x9;&#x9;rmvTr('totalsTable', 'equipmentInstallmentTR');&#xA;&#x9;&#x9;&#x9;budgetValues.installments.products = 1;&#xA;&#x9;&#x9;} else if (getElement('equipmentInstallmentTR') == null) { // add TR&#xA;&#x9;&#x9;&#x9;var row = getElement('totalsTable').insertRow(6);&#xA;&#x9;&#x9;&#x9;row.id = 'equipmentInstallmentTR';&#xA;&#x9;&#x9;&#x9;row.insertCell(0).innerHTML = 'Equipamentos: ';&#xA;&#x9;&#x9;&#x9;row.insertCell(1).innerHTML = '<select class=\'form-item\' style=\'min-width: 40px; max-width: 80px;\' id=\'paymentItemParcels\' onchange=\'handleInstallments();\'&gt;' + getQuantityOptions(1, 10, false) + '</select&gt;';&#xA;&#x9;&#x9;&#x9;row.insertCell(2).innerHTML = '<span style=\'padding-left: 10px;\' id=\'totalParcelItemValue\'&gt;$0.00</span&gt;';&#xA;&#x9;&#x9;}&#xA;&#x9;&#x9;var totalItems = 0, totalInstalls = 0, totalServices = 0;&#xA;&#xA;&#x9;&#x9;// totals&#xA;&#x9;&#x9;for (var i = 0; i < budgetValues.products.length; i++) {&#xA;&#x9;&#x9;&#x9;budgetValues.products[i].tPrice = &#xA;&#x9;&#x9;&#x9;&#x9;(budgetValues.products[i].item.unitPrice(mode) * budgetValues.products[i].qty) +&#xA;&#x9;&#x9;&#x9;&#x9;(budgetValues.products[i].item.installPrice * budgetValues.products[i].qty);&#xA;&#x9;&#x9;&#x9;if (getElement('qty' + budgetValues.products[i].id) != null) getElement('qty' + budgetValues.products[i].id).value = budgetValues.products[i].qty;&#xA;&#x9;&#x9;&#x9;getElement('up' + budgetValues.products[i].id).innerHTML = '$' + budgetValues.products[i].item.unitPrice(mode).toFixed(2);&#xA;&#x9;&#x9;&#x9;getElement('tp' + budgetValues.products[i].id).innerHTML = (mode == 0) ? '$' + budgetValues.products[i].tPrice.toFixed(2) : '-'; // only show if mode = 'Venda'&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;totalItems += parseFloat(parseFloat(budgetValues.products[i].item.unitPrice(mode)) * parseFloat(budgetValues.products[i].qty));&#xA;&#x9;&#x9;&#x9;totalInstalls += parseFloat(parseFloat(budgetValues.products[i].item.installPrice) * parseFloat(budgetValues.products[i].qty));&#xA;&#x9;&#x9;}&#xA;&#x9;&#x9;for (var i = 0; i < budgetValues.services.length; i++) {&#xA;&#x9;&#x9;&#x9;budgetValues.services[i].tPrice = (budgetValues.services[i].service.price * budgetValues.services[i].qty);&#xA;&#x9;&#x9;&#x9;if (getElement('qty' + budgetValues.services[i].id) != null) getElement('qty' + budgetValues.services[i].id).value = budgetValues.services[i].qty;&#x9;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;getElement('tp' + budgetValues.services[i].id).innerHTML = '$' + budgetValues.services[i].tPrice.toFixed(2);&#xA;&#x9;&#x9;&#x9;totalServices += parseFloat(parseFloat(budgetValues.services[i].service.price) * parseFloat(budgetValues.services[i].qty));&#xA;&#x9;&#x9;}&#xA;&#x9;&#x9;getElement('totalItems').innerHTML = parseFloat(totalInstalls + totalItems).toFixed(2);&#xA;&#x9;&#x9;getElement('totalServices').innerHTML = totalServices.toFixed(2);&#xA;&#x9;&#x9;budgetValues.totals.item = totalItems;&#xA;&#x9;&#x9;budgetValues.totals.srv = totalServices;&#xA;&#xA;&#x9;&#x9;// determine increases&#xA;&#x9;&#x9;if (budgetValues.cs == 1 &amp;&amp; budgetValues.bj == 1) {&#xA;&#x9;&#x9;&#x9;budgetValues.totals.inst = totalInstalls;&#xA;&#x9;&#x9;&#x9;getElement('totalsNotes').innerHTML = '';&#xA;&#x9;&#x9;} else {&#xA;&#x9;&#x9;&#x9;var increase = 0;&#xA;&#x9;&#x9;&#x9;if (budgetValues.cs == 2) increase += 20;&#xA;&#xA;&#x9;&#x9;&#x9;if (budgetValues.bj == 2) increase += 5;&#xA;&#x9;&#x9;&#x9;else if (budgetValues.bj == 3) increase += 20;&#xA;&#xA;&#x9;&#x9;&#x9;budgetValues.totals.inst = totalInstalls + ((totalInstalls * increase)/100);&#xA;&#x9;&#x9;&#x9;var text = '* Acr��scimo de ' + increase + '% devido a ';&#xA;&#x9;&#x9;&#x9;if (budgetValues.cs == 2) text += 'Instala����o fora de hor��rio comercial';&#xA;&#x9;&#x9;&#x9;if (budgetValues.bj == 2) text += ((budgetValues.cs == 2) ? ' e ' : '') + 'Grande Obra inferior a 2000m';&#xA;&#x9;&#x9;&#x9;else if (budgetValues.bj == 3) text += ((budgetValues.cs == 2) ? ' e ' : '') + 'Grande Obra superior a 2000m';&#xA;&#x9;&#x9;&#x9;getElement('totalsNotes').innerHTML = text;&#xA;&#x9;&#x9;}&#xA;&#xA;&#x9;&#x9;// discounts&#xA;&#x9;&#x9;var serviceDiscount = parseFloat(budgetValues.disc.srv * (budgetValues.totals.srv/100));&#xA;&#x9;&#x9;var installDiscount = parseFloat(budgetValues.disc.inst * (budgetValues.totals.inst/100));&#xA;&#x9;&#x9;var itemDiscount = parseFloat(budgetValues.disc.item * (budgetValues.totals.item/100));&#xA;&#x9;&#x9;getElement('totalItemDiscount').innerHTML = itemDiscount.toFixed(2) + ' ($' + totalItems.toFixed(2) + ')';&#xA;&#x9;&#x9;getElement('totalInstallDiscount').innerHTML = installDiscount.toFixed(2) + ' ($' + budgetValues.totals.inst.toFixed(2) + ')' &#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;+ ((budgetValues.cs == 1 &amp;&amp; budgetValues.bj == 1) ? '' : ' *');&#xA;&#x9;&#x9;getElement('totalServiceDiscount').innerHTML = serviceDiscount.toFixed(2) + ' ($' + totalServices.toFixed(2) + ')';&#xA;&#x9;&#x9;var totalDiscount = parseFloat(itemDiscount + installDiscount + serviceDiscount);&#xA;&#x9;&#x9;getElement('totalDiscount').innerHTML = totalDiscount.toFixed(2);&#xA;&#x9;&#x9;getElement('totalInstall').innerHTML = parseFloat(budgetValues.totals.inst - installDiscount).toFixed(2);&#xA;&#xA;&#x9;&#x9;var grandTotal = parseFloat(budgetValues.totals.item + budgetValues.totals.inst + budgetValues.totals.srv - totalDiscount);&#xA;&#x9;&#x9;getElement('grandTotal').innerHTML = grandTotal.toFixed(2);&#xA;&#x9;&#x9;getElement('totalSale').innerHTML = parseFloat(totalItems - itemDiscount).toFixed(2);&#xA;&#x9;&#x9;getElement('totalService').innerHTML = parseFloat(totalServices - serviceDiscount).toFixed(2);&#xA;&#x9;&#x9;getElement('installMarker').innerHTML = ((budgetValues.cs == 1 &amp;&amp; budgetValues.bj == 1) ? '' : ' *');&#xA;&#x9;&#x9;&#xA;&#x9;&#x9;// installments&#xA;&#x9;&#x9;if (mode == 0) getElement('totalParcelItemValue').innerHTML = '$' + parseFloat((budgetValues.totals.item - itemDiscount) / budgetValues.installments.products).toFixed(2) + ' ($' + parseFloat(budgetValues.totals.item - itemDiscount).toFixed(2) + ')';&#xA;&#x9;&#x9;getElement('totalParcelInstallValue').innerHTML = '$' + parseFloat((budgetValues.totals.inst - installDiscount) / budgetValues.installments.install).toFixed(2) &#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;+ ' ($' + parseFloat(budgetValues.totals.inst - installDiscount).toFixed(2) + ')' &#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;+ ((budgetValues.cs == 1 &amp;&amp; budgetValues.bj == 1) ? '' : ' *');&#xA;&#x9;&#x9;budgetValues.totalMonthlyPayment = (mode == 0) ? parseFloat(parseFloat((budgetValues.totals.item - itemDiscount) / budgetValues.installments.products) + parseFloat((budgetValues.totals.inst - installDiscount) / budgetValues.installments.install))&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;   : parseFloat((budgetValues.totals.inst - installDiscount) / budgetValues.installments.install);&#xA;&#x9;&#x9;getElement('totalMonthlyPayment').innerHTML = budgetValues.totalMonthlyPayment.toFixed(2);&#xA;&#x9;&#x9;getElement('totalMonthly').innerHTML = (mode == 0) ? parseFloat(budgetValues.totals.srv - serviceDiscount).toFixed(2)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;   : parseFloat(budgetValues.totals.srv - serviceDiscount + budgetValues.totals.item - itemDiscount).toFixed(2);&#xA;&#x9;&#x9;budgetValues.grandTotal = grandTotal;&#xA;&#x9;&#x9;writeToFinalValue();&#xA;&#x9;&#x9;return false;&#xA;&#x9;};&#xA;&#x9;window['writeToFinalValue'] = function () {//GB&#xA;&#x9;&#x9;console.log('writing to final value...');&#xA;&#x9;&#x9;console.log(budgetValues);&#xA;&#x9;&#x9;var prodType = '';&#xA;&#x9;&#x9;var nommes = '';&#xA;&#x9;&#x9;var nummes = '';&#xA;                var diaP = '';&#xA;                var anoP = '';&#xA;                var dataP = '';&#xA;                var dataP = new Date();&#xA;                var diaP = dataP.getDate();&#xA;                var anoP = dataP.getFullYear();&#xA;&#x9;&#x9;var nummes = dataP.getMonth();&#xA;&#x9;&#x9;if(nummes == 0) nommes ='janeiro';&#xA;&#x9;&#x9;if(nummes == 1) nommes ='fevereiro';&#xA;&#x9;&#x9;if(nummes == 2) nommes ='mar��o';&#xA;&#x9;&#x9;if(nummes == 3) nommes ='abril';&#xA;&#x9;&#x9;if(nummes == 4) nommes ='maio';&#xA;&#x9;&#x9;if(nummes == 5) nommes ='junho';&#xA;&#x9;&#x9;if(nummes == 6) nommes ='julho';&#xA;&#x9;&#x9;if(nummes == 7) nommes ='agosto';&#xA;&#x9;&#x9;if(nummes == 8) nommes ='setembro';&#xA;&#x9;&#x9;if(nummes == 9) nommes ='outubro';&#xA;&#x9;&#x9;if(nummes == 10) nommes ='novembro';&#xA;&#x9;&#x9;if(nummes == 11) nommes ='dezembro';&#xA;&#x9;&#x9;if(budgetValues.pType == 0) prodType = 'Alarme';&#xA;&#x9;&#x9;if(budgetValues.pType == 1) prodType = 'CFTV';&#xA;&#x9;&#x9;if(budgetValues.pType == 2) prodType = 'Cerca';&#xA;&#x9;&#x9;if(budgetValues.pType == 3) prodType = 'Controle de Acesso';&#xA;&#x9;&#x9;if(budgetValues.pType == 4) prodType = 'Sistema de Incendio';&#xA;&#x9;&#x9;if(budgetValues.pType == 5) prodType = 'Alarme Mais';&#x9;&#x9;&#x9;&#x9;&#xA;                var mailData2 = 'S��o Paulo, ' + diaP + ' de ' + nommes + ' de ' + anoP + '\n';&#xA;&#x9;var emailData = 'Modalidade:' + ((budgetValues.mode == 0) ? 'Venda' : 'Comodato') + '\n';&#xA;&#x9;&#x9;emailData += 'Produto: ' + prodType + '\n'; &#x9;&#x9;emailData += 'Equipamentos\n';&#xA;&#x9;&#x9;var txt = '<modality&gt;' + ((budgetValues.mode == 0) ? 'Venda' : 'Comodato') + '</modality&gt;\n';&#xA;&#x9;&#x9;txt += '<product&gt;' + prodType + '</product&gt;\n';&#xA;&#x9;&#x9;txt += '<equipments&gt;\n';&#xA;&#x9;&#x9;for (var i = 0; i < budgetValues.products.length; i++) {&#xA;&#x9;&#x9;&#x9;var product = budgetValues.products[i];&#xA;&#x9;&#x9;&#x9;txt += '<equipment&gt;\n';&#xA;&#x9;&#x9;&#x9;txt += '<code&gt;' + product.item.itemId + '</code&gt;\n';&#xA;&#x9;&#x9;&#x9;txt += '<quantity&gt;' + product.qty + '</quantity&gt;\n';&#xA;&#x9;&#x9;&#x9;txt += '<move&gt;' + product.mov + '</move&gt;\n';&#xA;&#x9;&#x9;&#x9;txt += '<price&gt;' + product.item.unitPrice(budgetValues.mode) + '</price&gt;\n';&#xA;&#x9;&#x9;&#x9;txt += '<priceInstall&gt;' + product.item.installPrice + '</priceInstall&gt;\n';&#xA;&#x9;&#x9;&#x9;txt += '<totalPrice&gt;' + product.tPrice + '</totalPrice&gt;\n';&#xA;&#x9;&#x9;&#x9;txt += '</equipment&gt;\n';&#xA;&#x9;&#x9;&#x9;emailData += '\t' + product.qty + ' ' + '\t' +  product.item.name + '\n';&#xA;&#x9;&#x9;}&#xA;&#x9;&#x9;txt += '</equipments&gt;\n';&#xA;&#x9;&#x9;txt += '<services&gt;\n';&#xA;&#x9;&#x9;emailData += 'Servi��os\n';&#xA;&#x9;&#x9;for (var i = 0; i < budgetValues.services.length; i++) {&#xA;&#x9;&#x9;&#x9;var service = budgetValues.services[i];&#xA;&#x9;&#x9;&#x9;txt += '<service&gt;' + '\n';&#xA;&#x9;&#x9;&#x9;txt += '<code&gt;' + service.service.serviceId + '</code&gt;' + '\n';&#xA;&#x9;&#x9;&#x9;txt += '<quantity&gt;' + service.qty + '</quantity&gt;' + '\n';&#xA;&#x9;&#x9;&#x9;txt += '</service&gt;' + '\n';&#xA;&#x9;&#x9;&#x9;emailData += '\t' + service.qty + ' ' + '\t' + service.service.serviceId + ' ' + '\t' + service.service.name + '\t' + '\n'; &#xA;&#x9;&#x9;}&#xA;&#x9;&#x9;txt += '</services&gt;\n';&#xA;&#x9;&#x9;txt += '<discounts&gt;\n';&#xA;&#x9;&#x9;txt += '<product&gt;' + budgetValues.disc.item + '</product&gt;\n';&#xA;&#x9;&#x9;txt += '<installation&gt;' + budgetValues.disc.inst + '</installation&gt;\n';&#xA;&#x9;&#x9;txt += '<service&gt;' + budgetValues.disc.srv + '</service&gt;\n';&#xA;&#x9;&#x9;txt += '</discounts&gt;\n';&#xA;&#x9;&#x9;txt += '<commercialConditions&gt;\n';&#xA;&#x9;&#x9;txt += '<iInstall&gt;' + budgetValues.installments.install + '</iInstall&gt;\n';&#xA;&#x9;&#x9;txt += '<iProducts&gt;' + budgetValues.installments.products + '</iProducts&gt;\n';&#xA;&#x9;&#x9;txt += '</commercialConditions&gt;\n';&#xA;&#x9;&#x9;emailData += '\n';&#xA;                emailData += 'Valor total de Instala����o: R$ ' + parseFloat(parseFloat(budgetValues.totals.inst) - (parseFloat(budgetValues.disc.inst) * parseFloat(budgetValues.totals.inst/100))).toFixed(2) + '\n';&#xA;                 emailData += 'Parcelado em: ' + budgetValues.installments.install + 'x\n';&#xA;&#x9;&#x9;if (budgetValues.mode == 0) emailData += 'Valor total dos Equipamentos: R$ ' + parseFloat(parseFloat(budgetValues.totals.item) - (parseFloat(budgetValues.disc.item) * parseFloat(budgetValues.totals.item/100))).toFixed(2) + '\n';&#xA;                 if (budgetValues.mode == 0) emailData += 'Parcelado em: ' + budgetValues.installments.products + 'x\n'; &#xA;&#x9;&#x9;if (budgetValues.mode == 0) emailData += 'Mensalidade: R$ ' +  parseFloat(parseFloat(budgetValues.totals.srv) - (parseFloat(budgetValues.disc.srv) * parseFloat(budgetValues.totals.srv/100))).toFixed(2); &#xA;&#x9;&#x9;if (budgetValues.mode != 0) emailData += 'Mensalidade: R$ ' +  parseFloat(parseFloat(parseFloat(budgetValues.totals.item) - (parseFloat(budgetValues.disc.item) * parseFloat(budgetValues.totals.item/100))) + parseFloat(parseFloat(budgetValues.totals.srv) - (parseFloat(budgetValues.disc.srv) * parseFloat(budgetValues.totals.srv/100)))).toFixed(2); &#xA;&#x9;&#x9;if(isNaN(budgetValues.totalMonthlyPayment)) budgetValues.totalMonthlyPayment = 0;&#xA;&#x9;&#x9;if(!isFinite(budgetValues.totalMonthlyPayment)) budgetValues.totalMonthlyPayment = 0;&#xA;&#x9;&#x9;var vt = '$' + parseFloat(budgetValues.grandTotal).toFixed(2);&#xA;&#x9;&#x9;&#x9;var mp = '$' + parseFloat(budgetValues.totalMonthlyPayment).toFixed(2);&#xA;&#x9;&#x9;/* write to values */&#xA;&#x9;&#x9;var aid = $app.request().getParameter('aid', 0);&#xA;&#x9;&#x9;var currTab = $app.request().getParameter('tabId', null);&#xA;&#x9;&#x9;$app.request().setParameter('tabId', '6351');&#xA;&#x9;&#x9;$app.http().sync($.Form.generateKey(), 'mobile_activity_details', {&#xA;&#x9;&#x9;items: {&#xA;&#x9;&#x9;&#x9;'426': txt,&#xA;&#x9;&#x9;&#x9;'476': JSON.stringify(budgetValues),&#xA;&#x9;&#x9;&#x9;'477': mp,&#xA;&#x9;&#x9;&#x9;'478': emailData,&#xA;&#x9;&#x9;&#x9;'707': mailData2,&#xA;&#x9;&#x9;&#x9;'479': vt,&#xA;&#x9;&#x9;&#x9;'aid': aid&#xA;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;});&#xA;&#x9;&#x9;$app.request().setParameter('tabId', currTab);&#xA;&#x9;&#x9;return false;&#xA;&#x9;}&#xA;&#x9;window['getFieldValue'] = function(fieldId) {&#xA;&#x9;&#x9;var aid = $app.request().getParameter('aid', null);&#xA;&#x9;&#x9;var act = $app.storage().get('Activity')[aid];&#xA;&#x9;&#x9;if (!act) {&#xA;&#x9;&#x9;&#x9;return null;&#xA;&#x9;&#x9;}&#xA;&#x9;&#x9;var result = act[fieldId];&#xA;&#x9;&#x9;return result;&#xA;&#x9;}&#xA;&#x9;window['removalItems'] = []; // variable where cascade removals are stored&#xA;&#x9;window['applyRemovals'] = function () {&#xA;&#x9;&#x9;for (var i = (budgetValues.products.length-1); i &gt;= 0; i--) {&#xA;&#x9;&#x9;&#x9;if (budgetValues.products[i].ruleType == 'IT' &amp;&amp; budgetValues.products[i].ruleItem != null) {&#xA;&#x9;&#x9;&#x9;&#x9;var obj = findBudgetItem(budgetValues.products[i].ruleItem);&#xA;&#x9;&#x9;&#x9;&#x9;if (obj == null) obj = findBudgetService(budgetValues.products[i].ruleItem);&#xA;&#x9;&#x9;&#x9;&#x9;if (obj == null) { // no more parent&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;rmvTr('tblItems', budgetValues.products[i].id); /* TODO: autoQty < qty? */&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;optionEnable(getElement('itemValues'), budgetValues.products[i].item.itemId, true);&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;handleExclusions(budgetValues.products[i].item, true);&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;budgetValues.products = rmvArrEl(budgetValues.products, i);&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;return true;&#xA;&#x9;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;}&#xA;&#x9;&#x9;for (var i = (budgetValues.services.length-1); i &gt;= 0; i--) {&#xA;&#x9;&#x9;&#x9;if (budgetValues.services[i].ruleType == 'IT' &amp;&amp; budgetValues.services[i].ruleItem != null) {&#xA;&#x9;&#x9;&#x9;&#x9;var obj = findBudgetItem(budgetValues.services[i].ruleItem);&#xA;&#x9;&#x9;&#x9;&#x9;if (obj == null) obj = findBudgetService(budgetValues.services[i].ruleItem);&#xA;&#x9;&#x9;&#x9;&#x9;if (obj == null) { // no more parent&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;rmvTr('tblServices', budgetValues.services[i].id); /* TODO: autoQty < qty? */&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;optionEnable(getElement('serviceValues'), budgetValues.services[i].service.serviceId, true);&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;handleExclusions(budgetValues.services[i].service, true);&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;budgetValues.services = rmvArrEl(budgetValues.services, i);&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;return true;&#xA;&#x9;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;}&#xA;&#x9;&#x9;return false;&#xA;&#x9;}&#xA;&#x9;window['handleOptions'] = function (itemId) {&#xA;&#x9;&#x9;for (var i = 0; i < aggOptions.length; i++) {&#xA;&#x9;&#x9;&#x9;if (aggOptions[i].product == itemId) {&#xA;&#x9;&#x9;&#x9;&#x9;var row = getElement('tblMainOptions').insertRow(budgetValues.lastTblIdx);&#xA;&#x9;&#x9;&#x9;&#x9;row.id = 'opts' + aggOptions[i].id;&#xA;&#x9;&#x9;&#x9;&#x9;row.className = 'mainOptionsRow';&#xA;&#x9;&#x9;&#x9;&#x9;row.insertCell(0).innerHTML = aggOptions[i].text;&#xA;&#x9;&#x9;&#x9;&#x9;row.insertCell(1).innerHTML = '<select onchange=\'return updateOptions(&amp;#39;' + aggOptions[i].tag + '&amp;#39;, &amp;#39;' + aggOptions[i].id + '&amp;#39;, &amp;#39;' + itemId + '&amp;#39;, this.value);\' name=\'optsEditor' + aggOptions[i].id + '\' onchange=\'return applyOptions(&amp;#39;optsEditor' + aggOptions[i].id + '&amp;#39;, this.value);\' class=\'form-item\'&gt;<option selected=\'selected\' value=\'Y\'&gt;Sim</option&gt;<option value=\'N\'&gt;N��o</option&gt;</select&gt;';&#xA;&#x9;&#x9;&#x9;&#x9;row.insertCell(2).innerHTML = '';&#xA;&#x9;&#x9;&#x9;&#x9;row.insertCell(3).innerHTML = '';&#xA;&#x9;&#x9;&#x9;&#x9;row.insertCell(4).innerHTML = '';&#xA;&#x9;&#x9;&#x9;&#x9;budgetValues.optionals.push( {name: aggOptions[i].tag, value: 'Y', rowid: row.id, optional: aggOptions[i]} );&#xA;&#x9;&#x9;&#x9;&#x9;budgetValues.lastTblIdx++;&#xA;&#x9;&#x9;&#x9;&#x9;applyOptions(itemId, 'optsEditor' + aggOptions[i].id, 'Y');&#xA;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;}&#xA;&#x9;&#x9;return false;&#xA;&#x9;}&#xA;&#x9;window['applyOptions'] = function (itemId, optionId, value) {&#xA;&#x9;&#x9;for (var i = 0; i < aggOptions.length; i++) {&#xA;&#x9;&#x9;&#x9;if (itemId == aggOptions[i].product &amp;&amp; ('optsEditor' + aggOptions[i].id) == optionId) {&#xA;&#x9;&#x9;&#x9;&#x9;colIdx = 5, rowNum = 0;&#xA;&#x9;&#x9;&#x9;&#x9;var row = null;&#xA;&#x9;&#x9;&#x9;&#x9;for (var j = 0; j < aggOptions[i].rules.length; j++) {&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;if (colIdx &gt;= 5 &amp;&amp; (j+1) < aggOptions[i].rules.length) {&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;row = getElement('tblMainOptions').insertRow(budgetValues.lastTblIdx);&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;row.id = 'rule' + aggOptions[i].rules[j].id + '-' + rowNum;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;row.className = 'mainOptionsRow';&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;colIdx = 0; budgetValues.lastTblIdx++; rowNum++;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;if (aggOptions[i].rules[j].answer == value) {&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;if (aggOptions[i].rules[j].editor == 'A') {&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;var num = aggOptions[i].rules[j].text.substring(0, aggOptions[i].rules[j].text.indexOf('-'));&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;var iid = aggOptions[i].rules[j].text.substring(aggOptions[i].rules[j].text.indexOf('-') + 1);&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;var obj = findItem(iid);&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;if (obj == null) obj = findService(iid);&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;if (obj == null) continue;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;if (obj.type == 'product') addItem(iid, 'Opcionais', 'OP');&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;else addService(iid, 'Opcionais', 'OP');&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;if (num &gt; 1) {&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;obj = ((obj.type == 'product') ? findBudgetItem(iid) : findBudgetService(iid));&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;obj.qty = num;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;obj.autoQty = num;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;if (obj.type == 'product') updateItem(obj);&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;else updateService(obj);&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;updateMinMaxOptions(getElement('qty' + obj.id), num, 1000000); // cannot be lower than 'num'&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;} else {&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;row.insertCell(colIdx++).innerHTML = aggOptions[i].rules[j].text;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;var txt = '', val = '';&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;if (aggOptions[i].rules[j].editor == 'S') {&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;txt = '<select onchange=\'return updateOptions(&amp;#39;' + aggOptions[i].rules[j].tag + '&amp;#39;, null, null, this.value);\' name=\'' + aggOptions[i].rules[j].tag + '\' class=\'form-item\'&gt;';&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;var options = aggOptions[i].rules[j].values.split(',');&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;for (var k = 0; k < options.length; k++) txt += '<option value=\'' + options[k].trim() + '\'&gt;' + options[k].trim() + '</option&gt;';&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;txt += '</select&gt;';&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;val = options[0];&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;} else {&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;var txt = '<input onchange=\'return updateOptions(&amp;#39;' + aggOptions[i].rules[j].tag + '&amp;#39;, null, null, this.value);\' onkeyup=\'return updateOptions(&amp;#39;' + aggOptions[i].rules[j].tag + '&amp;#39;, null, null, this.value);\' type=\'text\'';&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;if (aggOptions[i].rules[j].editor == 'N') txt += ' onkeypress=\'return event.charCode &gt;= 48 &amp;&amp; event.charCode <= 57\'';&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;txt += ' name=\'' + aggOptions[i].rules[j].tag + '\' class=\'form-item\'&gt;</input&gt;';&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;row.insertCell(colIdx++).innerHTML = txt;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;budgetValues.optionals.push( {name: aggOptions[i].rules[j].tag, value: val, rowid: row.id, optional: aggOptions[i].rules[j]} );&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;if (colIdx < 5) row.insertCell(colIdx++).innerHTML = '';&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;} else {&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;if (aggOptions[i].rules[j].editor == 'A') { // product/service added to the budget&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;var iid = aggOptions[i].rules[j].text.substring(aggOptions[i].rules[j].text.indexOf('-') + 1);&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;var obj = findBudgetItem(iid);&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;if (obj == null) obj = findBudgetService(iid);&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;if (obj == null) continue;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;removeItem( ((obj.type == 'service') ? 'tblServices' : 'tblItems' ), iid, true);&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;} else { // optional item added to the structure&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;for (var k = 0; k < budgetValues.optionals.length; k++) {&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;if (budgetValues.optionals[k].name == aggOptions[i].rules[j].tag) {&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;budgetValues.optionals = rmvArrEl(budgetValues.optionals, k); // remove from optionals&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;break;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;rn = 0;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;while (true) { // remove TRs for the rule&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;var tr = getElement('rule' + aggOptions[i].rules[j].id + '-' + rn);&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;if (tr == null) break;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;rmvTr('tblMainOptions', 'rule' + aggOptions[i].rules[j].id + '-' + rn++);&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;budgetValues.lastTblIdx--;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;}&#xA;&#x9;&#x9;return applyRules();&#xA;&#x9;}&#x9;&#xA;&#x9;window['getMoveOptions'] = function () {&#xA;&#x9;&#x9;var txtOptions = '<option value=\'1\'&gt;1-INCLUIR</option&gt;<option value=\'2\'&gt;2-REMANEJAR</option&gt;';&#xA;&#x9;&#x9;txtOptions += '<option value=\'3\'&gt;3-REINSTALAR</option&gt;<option value=\'4\'&gt;4-EXCLUIR</option&gt;';&#xA;&#x9;&#x9;txtOptions += '<option value=\'5\'&gt;5-EQUIP.EXISTENTES</option&gt;<option value=\'6\'&gt;6-EXCLUSIVO INSTALA����ES</option&gt;';&#xA;&#x9;&#x9;txtOptions += '<option value=\'7\'&gt;7-REPOSI����O</option&gt;';&#xA;&#x9;&#x9;return txtOptions;&#xA;&#x9;}&#xA;&#x9;window['getQuantityOptions'] = function (minOptions, maxOptions, withMax) {&#xA;&#x9;&#x9;var txtOptions = '';&#xA;&#x9;&#x9;for (var i = minOptions; i < (maxOptions+1); i++) txtOptions += '<option value=\'' + i + '\'&gt;' + i + '</option&gt;';&#xA;&#x9;&#x9;if (withMax) txtOptions += '<option value=\'+' + maxOptions + '\'&gt;+ ' + maxOptions + '</option&gt;'&#xA;&#x9;&#x9;return txtOptions;&#xA;&#x9;}&#xA;&#x9;window['handleAlarmType'] = function (recalc) {&#xA;&#x9;&#x9;if (getElement('projType').value == 0 &amp;&amp; getElement('alarmType') == null) {&#xA;&#x9;&#x9;&#x9;getElement('lblAlarmType').style.display = 'block';&#xA;&#x9;&#x9;&#x9;getElement('divAlarmTypes').innerHTML = '<select onchange=\'return handleAlarmType(true);\' id=\'alarmType\' class=\'form-item\'&gt;</select&gt;';&#xA;&#x9;&#x9;&#x9;var opts = getElement('alarmType');&#xA;&#x9;&#x9;&#x9;for (var i = 0; i < alarmTypes.length; i++) { opts.add(createOption(alarmTypes[i].id, alarmTypes[i].name)); }&#xA;&#x9;&#x9;} else if (getElement('projType').value != 0 &amp;&amp; getElement('alarmType') != null) {&#xA;&#x9;&#x9;&#x9;var alarmType = getAlarmType(budgetValues.alarmType);&#xA;&#x9;&#x9;&#x9;for (var i = 0; i < alarmType.rules.length; i++) {&#xA;&#x9;&#x9;&#x9;&#x9;var obj = findProductOrService(alarmType.rules[i].substring(alarmType.rules[i].indexOf('-') + 1));&#xA;&#x9;&#x9;&#x9;&#x9;if (obj == null) continue;&#xA;&#x9;&#x9;&#x9;&#x9;optionEnable(getElement(((obj.type == 'service') ? 'serviceValues' : 'itemValues')), alarmType.rules[i].substring(alarmType.rules[i].indexOf('-') + 1), true);&#xA;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;&#x9;handleExclusions(alarmType, true);&#xA;&#x9;&#x9;&#x9;budgetValues.alarmType = -1;&#xA;&#x9;&#x9;&#x9;getElement('lblAlarmType').style.display = 'none';&#xA;&#x9;&#x9;&#x9;getElement('divAlarmTypes').innerHTML = '';&#xA;&#x9;&#x9;}&#xA;&#x9;&#x9;if (budgetValues.alarmType != -1 &amp;&amp; recalc) { // remove items from previously selected alarm&#xA;&#x9;&#x9;&#x9;var alarmType = getAlarmType(budgetValues.alarmType);&#xA;&#x9;&#x9;&#x9;if (alarmType != null) {&#xA;&#x9;&#x9;&#x9;&#x9;for (var i = 0; i < alarmType.rules.length; i++) {&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;var obj = findBudgetItem(alarmType.rules[i].substring(alarmType.rules[i].indexOf('-') + 1));&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;if (obj == null) obj = findBudgetService(alarmType.rules[i].substring(alarmType.rules[i].indexOf('-') + 1));&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;if (obj == null) continue;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;removeItem( ((obj.type == 'service') ? 'tblServices' : 'tblItems' ), alarmType.rules[i].substring(alarmType.rules[i].indexOf('-') + 1), true);&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;optionEnable(getElement(((obj.type == 'service') ? 'serviceValues' : 'itemValues')), alarmType.rules[i].substring(alarmType.rules[i].indexOf('-') + 1), true);&#xA;&#x9;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;&#x9;&#x9;handleExclusions(alarmType, true);&#xA;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;}&#xA;&#xA;&#x9;&#x9;if (getElement('projType').value != 0) return false;&#xA;&#x9;&#x9;var alarmType = getAlarmType(getElement('alarmType').value);&#xA;&#x9;&#x9;if (!recalc) { // used on load from existing budget: return because items/services already added&#xA;&#x9;&#x9;&#x9;handleExclusions(alarmType, false); &#xA;&#x9;&#x9;&#x9;return false; &#xA;&#x9;&#x9;}&#xA;&#x9;&#x9;if (alarmType == null) return false;&#xA;&#x9;&#x9;budgetValues.alarmType = alarmType.id;&#xA;&#x9;&#x9;for (var i = 0; i < alarmType.rules.length; i++) {&#xA;&#x9;&#x9;&#x9;var num = alarmType.rules[i].substring(0, alarmType.rules[i].indexOf('-'));&#xA;&#x9;&#x9;&#x9;var iid = alarmType.rules[i].substring(alarmType.rules[i].indexOf('-') + 1);&#xA;&#x9;&#x9;&#x9;var obj = findItem(iid);&#xA;&#x9;&#x9;&#x9;if (obj == null) obj = findService(iid);&#xA;&#x9;&#x9;&#x9;if (obj == null) continue;&#xA;&#x9;&#x9;&#x9;if (obj.type == 'product') addItem(iid, 'Tipo de Alarme: ' + alarmType.name, 'AT');&#xA;&#x9;&#x9;&#x9;else addService(iid, 'Tipo de Alarme: ' + alarmType.name, 'AT');&#xA;&#x9;&#x9;&#x9;if (num &gt; 1) {&#xA;&#x9;&#x9;&#x9;&#x9;obj = ((obj.type == 'product') ? findBudgetItem(iid) : findBudgetService(iid));&#xA;&#x9;&#x9;&#x9;&#x9;obj.qty = num;&#xA;&#x9;&#x9;&#x9;&#x9;obj.autoQty = num;&#xA;&#x9;&#x9;&#x9;&#x9;if (obj.type == 'product') updateItem(obj);&#xA;&#x9;&#x9;&#x9;&#x9;else updateService(obj);&#xA;&#x9;&#x9;&#x9;&#x9;updateMinMaxOptions(getElement('qty' + obj.id), num, 1000000); // cannot be lower than 'num'&#xA;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;}&#xA;&#xA;&#x9;&#x9;handleExclusions(alarmType, false); // apply exclusions&#xA;&#xA;&#x9;&#x9;if (recalc) return recalculateTotals();&#xA;&#x9;&#x9;else return false;&#x9;&#x9;&#xA;&#x9;}&#xA;&#x9;window['addItem'] = function (iId, ruleItem, ruleType) {&#xA;&#x9;&#x9;console.log('addItem(' + iId + ', ' + ruleItem + ', ' + ruleType + ')');&#xA;&#x9;&#x9;var item = findItem(iId);&#xA;&#x9;&#x9;if (item == null) return false; // item not found&#xA;&#x9;&#x9;var el = { item: item, id: (new Date()).getTime(), mov: 1, qty: 1, &#xA;&#x9;&#x9;&#x9;autoQty: ((ruleItem != null) ? 1 : 0), ruleItem: ruleItem, type: item.type,&#xA;&#x9;&#x9;&#x9;ruleType: ruleType, tPrice: parseFloat(item.unitPrice(budgetValues.mode) + item.installPrice) };&#xA;&#xA;&#x9;&#x9;// insert the table row&#xA;&#x9;&#x9;var row = getElement('tblItems').insertRow(-1);&#xA;&#x9;&#x9;row.id = el.id;&#xA;&#x9;&#x9;var cellIdx = 0;&#xA;&#x9;&#x9;row.insertCell(cellIdx++).innerHTML = el.item.itemId;&#xA;&#x9;&#x9;row.insertCell(cellIdx++).innerHTML = (el.item.name.indexOf('-') != -1) ? el.item.name.substring(el.item.name.indexOf('-')+1) : el.item.name;&#xA;&#x9;&#x9;row.insertCell(cellIdx++).innerHTML = '<select class=\'form-item\' style=\'min-width: 40px;\' id=\'mov' + el.id + '\' onchange=\'return updateMoveOption(this.value, &amp;#39;' + el.item.itemId + '&amp;#39;);\'&gt;' + getMoveOptions() + '</select&gt;';&#xA;&#x9;&#x9;&#x9;row.insertCell(cellIdx++).innerHTML = '<select class=\'form-item\' style=\'min-width: 40px; max-width: 60px;\' id=\'qty' + el.id + '\' onchange=\'updateQty(&amp;#39;tblItems&amp;#39;, &amp;#39;' + el.item.itemId + '&amp;#39;, this.value); return false;\'&gt;' + getQuantityOptions(1, 200, true) + '</select&gt;';&#xA;&#x9;&#x9;&#x9;getElement('qty' + el.id).value = el.qty;&#xA;&#x9;&#x9;createCell(row, cellIdx++, 'up' + el.id, '$' + item.unitPrice(budgetValues.mode).toFixed(2));&#xA;&#x9;&#x9;row.insertCell(cellIdx++).innerHTML = '$' + item.installPrice.toFixed(2);&#xA;&#x9;&#x9;createCell(row, cellIdx++, 'tp' + el.id, '$' + el.tPrice.toFixed(2));&#xA;&#xA;&#x9;&#x9;budgetValues.products.push(el);&#xA;&#x9;&#x9;optionEnable(getElement('itemValues'), iId, false);&#xA;&#x9;&#xA;&#x9;&#x9;// handle optionals&#xA;&#x9;&#x9;handleOptions(iId);&#xA;&#x9;&#xA;&#x9;&#x9;if (ruleItem == null) {&#xA;&#x9;&#x9;&#x9;row.insertCell(cellIdx++).innerHTML = '<a href=\'javascript:void(0);\' onclick=\'removeItem(&amp;#39;tblItems&amp;#39;, &amp;#39;' + el.item.itemId + '&amp;#39;, true);\'&gt;Remover</a&gt;';&#xA;&#x9;&#x9;&#x9;handleExclusions(item, false);&#xA;&#x9;&#x9;&#x9;return applyRules();&#xA;&#x9;&#x9;} else {&#xA;&#x9;&#x9;&#x9;row.insertCell(cellIdx++).innerHTML = '<a href=\'javascript:void(0);\' style=\'color: #ccc\' title=\'Este item n��o pode ser removido porque faz parte de ' + ruleItem + '.\'&gt;Remover</a&gt;';&#xA;&#x9;&#x9;&#x9;handleExclusions(item, false);&#xA;&#x9;&#x9;&#x9;// return false;&#xA;&#x9;&#x9;&#x9;return applyRules();&#xA;&#x9;&#x9;}&#xA;&#x9;}&#xA;&#x9;window['addService'] = function (sId, ruleItem, ruleType) {&#xA;&#x9;&#x9;var service = findService(sId);&#xA;&#x9;&#x9;if (service == null) return false; // service not found&#xA;&#x9;&#x9;var el = { service: service, id: (new Date()).getTime(), qty: 1,&#xA;&#x9;&#x9;&#x9;autoQty: ((ruleItem != null) ? 1 : 0), ruleItem: ruleItem, type: service.type,&#xA;&#x9;&#x9;&#x9;ruleType: ruleType, tPrice: parseFloat(service.price) };&#xA;&#xA;&#x9;&#x9;// insert the table row&#xA;&#x9;&#x9;var row = getElement('tblServices').insertRow(-1);&#xA;&#x9;&#x9;row.id = el.id;&#xA;&#x9;&#x9;var cellIdx = 0;&#xA;&#x9;&#x9;row.insertCell(cellIdx++).innerHTML = el.service.serviceId;&#xA;&#x9;&#x9;row.insertCell(cellIdx++).innerHTML = (el.service.name.indexOf('-') != -1) ? el.service.name.substring(el.service.name.indexOf('-')+1) : el.service.name;&#xA;&#x9;&#x9;row.insertCell(cellIdx++).innerHTML =  '<select class=\'form-item\' style=\'min-width: 40px; max-width: 60px;\' id=\'qty' + el.id + '\' onchange=\'updateQty(&amp;#39;tblServices&amp;#39;, &amp;#39;' + el.service.serviceId + '&amp;#39;, this.value); return false;\'&gt;' + getQuantityOptions(1, 200, true) + '</select&gt;';&#xA;getElement('qty' + el.id).value = el.qty;&#xA;&#x9;&#x9;createCell(row, cellIdx++, 'up' + el.id, '$' + el.service.price.toFixed(2));&#xA;&#x9;&#x9;createCell(row, cellIdx++, 'tp' + el.id, '$' + el.tPrice);&#xA;&#xA;&#x9;&#x9;budgetValues.services.push(el);&#xA;&#x9;&#x9;optionEnable(getElement('serviceValues'), sId, false);&#xA;&#x9;&#x9;if (ruleItem == null) {&#xA;&#x9;&#x9;&#x9;row.insertCell(cellIdx++).innerHTML = '<a href=\'javascript:void(0);\' onclick=\'removeItem(&amp;#39;tblServices&amp;#39;, &amp;#39;' + el.service.serviceId + '&amp;#39;, true);\'&gt;Remover</a&gt;';&#xA;&#x9;&#x9;&#x9;handleExclusions(service, false);&#xA;&#x9;&#x9;&#x9;return applyRules();&#xA;&#x9;&#x9;} else {&#xA;&#x9;&#x9;&#x9;row.insertCell(cellIdx++).innerHTML = '<a href=\'javascript:void(0);\' style=\'color: #ccc\' title=\'Este item n��o pode ser removido porque faz parte de ' + ruleItem + '.\'&gt;Remover</a&gt;';&#xA;&#x9;&#x9;&#x9;handleExclusions(service, false);&#xA;&#x9;&#x9;&#x9;return applyRules();&#xA;&#x9;&#x9;&#x9;// return false;&#xA;&#x9;&#x9;}&#xA;&#x9;}&#x9;&#xA;&#x9;window['updateMinMaxOptions'] = function (opts, min, max) {&#xA;&#x9;&#x9;console.log('updateMinMaxOptions(opts, ' + min + ', ' + max + ')');&#xA;&#x9;&#x9;var maxValue = 0, minValue = 1000000; // TODO: 1.000.000 is never to loop. Test.&#xA;&#x9;&#x9;for (var i = (opts.options.length-1); i &gt;= 0; i--) {&#xA;&#x9;&#x9;&#x9;if (!isNaN(opts.options[i].value) &amp;&amp; &#xA;&#x9;&#x9;&#x9;&#x9;(parseInt(opts.options[i].value) < min || parseInt(opts.options[i].value) &gt; max)) {&#xA;&#x9;&#x9;&#x9;&#x9;opts.remove(i);&#xA;&#x9;&#x9;&#x9;&#x9;continue;&#xA;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;&#x9;if (!isNaN(opts.options[i].value) &amp;&amp; maxValue < parseInt(opts.options[i].value)) maxValue = parseInt(opts.options[i].value);&#xA;&#x9;&#x9;&#x9;if (!isNaN(opts.options[i].value) &amp;&amp; minValue &gt; parseInt(opts.options[i].value)) minValue = parseInt(opts.options[i].value);&#xA;&#x9;&#x9;}&#xA;&#x9;&#x9;if (minValue == 1000000) minValue = 1;&#xA;&#x9;&#x9;if (max < 1000000) {&#xA;&#x9;&#x9;&#x9;for (var i = (opts.options.length-1); i &gt;= 0; i--) { if (opts.options[i].value.indexOf('+') == 0) opts.remove(i); }&#xA;&#x9;&#x9;}&#xA;&#x9;&#x9;if (max != 1000000 &amp;&amp; max &gt; maxValue) {&#xA;&#x9;&#x9;&#x9;for (var i = (maxValue + 1); i < (max + 1); i++) opts.add(createOption(i, i));&#xA;&#x9;&#x9;}&#xA;&#x9;&#x9;if (min < minValue) {&#xA;&#x9;&#x9;&#x9;var idx = 0;&#xA;&#x9;&#x9;&#x9;for (var i = min; i < minValue; i++) opts.add(createOption(i, i), idx++);&#xA;&#x9;&#x9;}&#xA;&#x9;&#x9;return false;&#xA;&#x9;}&#x9;&#x9;&#xA;&#x9;window['addOptions'] = function (opts) {&#xA;&#x9;&#x9;var currentMax = 0, addVals = parseInt(opts.value.substring(1));&#xA;&#x9;&#x9;opts.remove(opts.selectedIndex);&#xA;&#x9;&#x9;for (var i = 0; i < opts.options.length; i++) {&#xA;&#x9;&#x9;&#x9;if (!isNaN(opts.options[i].value) &amp;&amp; parseInt(opts.options[i].value) &gt; currentMax) currentMax = parseInt(opts.options[i].value);&#xA;&#x9;&#x9;}&#xA;&#x9;&#x9;for (var i = 0; i < addVals; i++) { opts.add(createOption((++currentMax), currentMax)); }&#xA;&#x9;&#x9;opts.add(createOption('+' + addVals, '+ ' + addVals));&#xA;&#x9;&#x9;return false;&#xA;&#x9;}&#x9;&#xA;&#x9;window['handleProjectType'] = function (projectType, recalc) {&#xA;&#x9;&#x9;budgetValues.pType = parseInt(projectType);&#xA;&#x9;&#x9;if (recalc) {&#xA;&#x9;&#x9;&#x9;clearTable('tblItems');&#xA;&#x9;&#x9;&#x9;clearTable('tblServices');&#xA;&#x9;&#x9;&#x9;// remove optionals if any on screen&#xA;&#x9;&#x9;&#x9;for (var i = 0; i < budgetValues.products.length; i++) { removeAllOptions(budgetValues.products[i].item.itemId); }&#xA;&#x9;&#x9;&#x9;for (var i = 0; i < budgetValues.services.length; i++) { removeAllOptions(budgetValues.services[i].service.serviceId); }&#xA;&#x9;&#x9;&#x9;// clear the values in the budget&#xA;&#x9;&#x9;&#x9;budgetValues.products = [];&#xA;&#x9;&#x9;&#x9;budgetValues.services = [];&#xA;&#x9;&#x9;&#x9;budgetValues.optionals = [];&#xA;&#x9;&#x9;}&#x9;&#xA;&#x9;&#x9;// re-build options for the new project&#xA;&#x9;&#x9;var opts = getElement('itemValues');&#xA;&#x9;&#x9;removeOptions(opts); // remove all&#xA;&#x9;&#x9;var pt = getProjectType(budgetValues.pType);&#xA;&#x9;&#x9;var groups = pt.allowedGroups;&#xA;&#x9;&#x9;for (var i = 0; i < items.length; i++) {&#xA;&#x9;&#x9;&#x9;for (var j = 0; j < groups.length; j++) {&#xA;&#x9;&#x9;&#x9;&#x9;if (items[i].code == groups[j]) { // group is allowed?&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;var gr = document.createElement('OPTGROUP');&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;gr.label = items[i].group;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;for (var k = 0; k < items[i].products.length; k++) {&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;if (!arrayContains(pt.excludeItems, items[i].products[k].itemId)) {&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;var opt = document.createElement('OPTION');&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;opt.innerHTML = items[i].products[k].name;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;opt.value = items[i].products[k].itemId;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;gr.appendChild(opt);&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;opts.appendChild(gr);&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;break;&#xA;&#x9;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;}&#xA;&#x9;&#x9;var optsProj = getElement('projType');&#xA;&#x9;&#x9;getElement('projectDesc').innerHTML = 'Projeto ' + optsProj.options[optsProj.selectedIndex].text;&#xA;&#x9;&#xA;&#x9;&#x9;// project type rules&#xA;&#x9;&#x9;for (var i = 0; i < pt.rules.length &amp;&amp; recalc; i++) {&#xA;&#x9;&#x9;&#x9;console.log('project rule: ' + pt.rules[i]);&#xA;&#x9;&#x9;&#x9;var obj = findItem(pt.rules[i]);&#xA;&#x9;&#x9;&#x9;if (obj == null) obj = findService(pt.rules[i]);&#xA;&#x9;&#x9;&#x9;if (obj == null) continue;&#xA;&#x9;&#x9;&#x9;if (obj.type == 'product') addItem(pt.rules[i], 'Tipo de Projeto: ' + pt.name, 'PT');&#xA;&#x9;&#x9;&#x9;else addService(pt.rules[i], 'Tipo de Projeto: ' + pt.name, 'PT');&#xA;&#x9;&#x9;}&#xA;&#xA;&#x9;&#x9;if (budgetValues.pType == 2) budgetValues.mode = 0;&#xA;&#x9;&#x9;optionEnable(getElement('pType'), '1', (budgetValues.pType != 2));&#xA;&#x9;&#x9;&#xA;&#x9;&#x9;handleAlarmType(recalc); // handles the alarm type&#xA;&#xA;&#x9;&#x9;if (recalc) return recalculateTotals();&#xA;&#x9;&#x9;else return false;&#xA;&#x9;}&#x9;&#xA;}&#xA;&#xA;// populate options&#xA;var opts = getElement('serviceValues'); removeOptions(opts);&#xA;for (var i = 0; i < services.length; i++) { opts.add(createOption(services[i].serviceId, services[i].name)); }&#xA;opts = getElement('paymentInstallParcels'); removeOptions(opts);&#xA;for (var i = 0; i < 12; i++) { opts.add(createOption((i+1), (i+1))); }&#xA;opts = getElement('paymentItemParcels'); removeOptions(opts);&#xA;for (var i = 0; i < 12; i++) { opts.add(createOption((i+1), (i+1))); }&#xA;opts = getElement('itemDiscount'); removeOptions(opts);&#xA;for (var i = 0; i < 26; i++) { opts.add(createOption(i, i + '%')); }&#xA;opts = getElement('installDiscount'); removeOptions(opts);&#xA;for (var i = 0; i < 101; i++) { opts.add(createOption(i, i + '%')); }&#xA;opts = getElement('serviceDiscount'); removeOptions(opts);&#xA;for (var i = 0; i < 26; i++) { opts.add(createOption(i, i + '%')); }&#xA;opts = getElement('projType'); removeOptions(opts);&#xA;for (var i = 0; i < projectTypes.length; i++) { opts.add(createOption(projectTypes[i].id, projectTypes[i].name)); }&#xA;&#xA;getElement('pType').selectedIndex = 0;&#xA;getElement('projType').selectedIndex = 0;&#xA;getElement('itemDiscount').selectedIndex = 0;&#xA;getElement('installDiscount').selectedIndex = 0;&#xA;getElement('serviceDiscount').selectedIndex = 0;&#xA;getElement('paymentItemParcels').selectedIndex = 0;&#xA;getElement('paymentInstallParcels').selectedIndex = 0;&#xA;getElement('divOverview').style.display = 'none';&#xA;getElement('divItems').style.display = 'none';&#xA;getElement('divServices').style.display = 'none';&#xA;clearTable('tblItems');&#xA;clearTable('tblServices');&#xA;&#xA;// begin reload from budget in progress logic&#xA;var existingOffer = getFieldValue(proposalData);&#xA;window['budgetValues'] = null;&#xA;if (existingOffer != null &amp;&amp; existingOffer != '' &amp;&amp; existingOffer.trim() != '') {&#xA;&#x9;budgetValues = JSON.parse(existingOffer);&#xA;&#x9;for (var i = 0; i < budgetValues.products.length; i++) budgetValues.products[i].item.unitPrice = function (mode) { return (mode == 0) ? parseFloat(this.salePrice) : parseFloat(this.rentalPrice); };&#xA;&#x9;getElement('pType').selectedIndex = budgetValues.mode;&#xA;&#x9;getElement('projType').value = budgetValues.pType;&#xA;&#x9;var mode = budgetValues.mode;&#xA;&#x9;for (var i = 0; i < budgetValues.products.length; i++) {&#xA;&#x9;&#x9;var el = budgetValues.products[i];&#xA;&#x9;&#x9;var cellIdx = 0;&#xA;&#x9;&#x9;var row = getElement('tblItems').insertRow(-1);&#xA;&#x9;&#x9;row.id = el.id;&#xA;&#x9;&#x9;row.insertCell(cellIdx++).innerHTML = el.item.itemId;&#xA;&#x9;&#x9;row.insertCell(cellIdx++).innerHTML = (el.item.name.indexOf('-') != -1) ? el.item.name.substring(el.item.name.indexOf('-')+1) : el.item.name;&#xA;&#x9;&#x9;row.insertCell(cellIdx++).innerHTML = '<select class=\'form-item\' style=\'min-width: 40px;\' id=\'mov' + el.id + '\' onchange=\'return updateMoveOption(this.value, &amp;#39;' + el.item.itemId + '&amp;#39;);\'&gt;' + getMoveOptions() + '</select&gt;';&#xA;&#x9;&#x9;&#x9;row.insertCell(cellIdx++).innerHTML = '<select class=\'form-item\' style=\'min-width: 40px; max-width: 60px;\' id=\'qty' + el.id + '\' onchange=\'updateQty(&amp;#39;tblItems&amp;#39;, &amp;#39;' + el.item.itemId + '&amp;#39;, this.value); return false;\'&gt;' + getQuantityOptions(1, 200, true) + '</select&gt;';&#xA;&#x9;&#x9;&#x9;getElement('qty' + el.id).value = el.qty;&#xA;&#x9;&#x9;getElement('mov' + el.id).value = el.mov;&#xA;&#x9;&#x9;createCell(row, cellIdx++, 'up' + el.id, '$' + el.item.unitPrice(budgetValues.mode).toFixed(2));&#xA;&#x9;&#x9;row.insertCell(cellIdx++).innerHTML = '$' + el.item.installPrice.toFixed(2);&#xA;&#x9;&#x9;createCell(row, cellIdx++, 'tp' + el.id, '$' + el.tPrice);&#xA;&#x9;&#x9;if (el.ruleItem == null) {&#xA;&#x9;&#x9;&#x9;row.insertCell(cellIdx++).innerHTML = '<a href=\'javascript:void(0);\' onclick=\'removeItem(&amp;#39;tblItems&amp;#39;, &amp;#39;' + el.item.itemId + '&amp;#39;, true);\'&gt;Remover</a&gt;';&#xA;&#x9;&#x9;} else {&#xA;&#x9;&#x9;&#x9;row.insertCell(cellIdx++).innerHTML = '<a href=\'javascript:void(0);\' style=\'color: #ccc\' title=\'Este item n��o pode ser removido porque faz parte de ' + el.ruleItem + '.\'&gt;Remover</a&gt;';&#xA;&#x9;&#x9;}&#xA;&#x9;&#x9;optionEnable(getElement('itemValues'), el.item.itemId, false);&#xA;&#x9;&#x9;handleExclusions(el.item, false);&#xA;&#x9;}&#xA;&#x9;for (var i = 0; i < budgetValues.services.length; i++) {&#xA;&#x9;&#x9;var el = budgetValues.services[i];&#xA;&#x9;&#x9;var cellIdx = 0;&#xA;&#x9;&#x9;var row = getElement('tblServices').insertRow(-1);&#xA;&#x9;&#x9;row.id = el.id;&#xA;&#x9;&#x9;row.insertCell(cellIdx++).innerHTML = el.service.serviceId;&#xA;&#x9;&#x9;row.insertCell(cellIdx++).innerHTML = (el.service.name.indexOf('-') != -1) ? el.service.name.substring(el.service.name.indexOf('-')+1) : el.service.name;&#xA;&#x9;&#x9;row.insertCell(cellIdx++).innerHTML =  '<select class=\'form-item\' style=\'min-width: 40px; max-width: 60px;\' id=\'qty' + el.id + '\' onchange=\'updateQty(&amp;#39;tblServices&amp;#39;, &amp;#39;' + el.service.serviceId + '&amp;#39;, this.value); return false;\'&gt;' + getQuantityOptions(1, 200, true) + '</select&gt;';&#xA;&#x9;&#x9;getElement('qty' + el.id).value = el.qty;&#xA;&#xA;&#x9;&#x9;createCell(row, cellIdx++, 'up' + el.id, '$' + el.service.price.toFixed(2));&#xA;&#x9;&#x9;createCell(row, cellIdx++, 'tp' + el.id, '$' + el.tPrice);&#xA;&#x9;&#x9;if (el.ruleItem == null) {&#xA;&#x9;&#x9;&#x9;row.insertCell(cellIdx++).innerHTML = '<a href=\'javascript:void(0);\' onclick=\'removeItem(&amp;#39;tblServices&amp;#39;, &amp;#39;' + el.service.serviceId + '&amp;#39;, true);\'&gt;Remover</a&gt;';&#xA;&#x9;&#x9;} else {&#xA;&#x9;&#x9;&#x9;row.insertCell(cellIdx++).innerHTML = '<a href=\'javascript:void(0);\' style=\'color: #ccc\' title=\'Este item n��o pode ser removido porque faz parte de ' + el.ruleItem + '.\'&gt;Remover</a&gt;';&#xA;&#x9;&#x9;}&#xA;&#x9;&#x9;optionEnable(getElement('serviceValues'), el.service.serviceId, false);&#xA;&#x9;&#x9;handleExclusions(el.service, false);&#xA;&#x9;}&#xA;&#x9;&#xA;&#x9;getElement('itemDiscount').selectedIndex = budgetValues.disc.item;&#xA;&#x9;getElement('installDiscount').selectedIndex = budgetValues.disc.inst;&#xA;&#x9;getElement('serviceDiscount').selectedIndex = budgetValues.disc.srv;&#xA;&#x9;if (budgetValues.mode == 0) getElement('paymentItemParcels').selectedIndex = (budgetValues.installments.products - 1);&#xA;&#x9;getElement('paymentInstallParcels').selectedIndex = (budgetValues.installments.install - 1);&#xA;&#x9;getElement('installTime').value = budgetValues.cs;&#xA;&#x9;getElement('bigJob').value = budgetValues.bj;&#xA;&#x9;getElement('underWork').value = budgetValues.uw;&#xA;&#x9;&#xA;&#x9;handleProjectType(budgetValues.pType, false);&#xA;&#x9;window['lastTblColIdx'] = 0;&#xA;&#x9;&#xA;&#x9;// reload optionals&#xA;&#x9;var col = true, lastRow = null;&#xA;&#x9;for (var i = 0; i < budgetValues.optionals.length; i++) {&#xA;&#x9;&#x9;if (budgetValues.optionals[i].rowid.indexOf('opts') == 0) { // this is an option&#xA;&#x9;&#x9;&#x9;var row = getElement('tblMainOptions').insertRow(-1);&#xA;&#x9;&#x9;&#x9;row.id = budgetValues.optionals[i].rowid;&#xA;&#x9;&#x9;&#x9;row.className = 'trH25';&#xA;&#x9;&#x9;&#x9;row.insertCell(0).innerHTML = budgetValues.optionals[i].optional.text;&#xA;&#x9;&#x9;&#x9;row.insertCell(1).innerHTML = '<select onchange=\'return updateOptions(&amp;#39;' + budgetValues.optionals[i].name + '&amp;#39;, &amp;#39;' + budgetValues.optionals[i].optional.id + '&amp;#39;, &amp;#39;' + budgetValues.optionals[i].optional.itemId + '&amp;#39;, this.value);\' name=\'optsEditor' + budgetValues.optionals[i].optional.id + '\' id=\'optsEditor' + budgetValues.optionals[i].optional.id + '\' onchange=\'return applyOptions(&amp;#39;optsEditor' + budgetValues.optionals[i].optional.id + '&amp;#39;, this.value);\'&gt;<option value=\'Y\'&gt;Sim</option&gt;<option value=\'N\'&gt;N��o</option&gt;</select&gt;';&#xA;&#x9;&#x9;&#x9;getElement('optsEditor' + budgetValues.optionals[i].optional.id).value = budgetValues.optionals[i].value;&#xA;&#x9;&#x9;&#x9;row.insertCell(2).innerHTML = '';&#xA;&#x9;&#x9;&#x9;row.insertCell(3).innerHTML = '';&#xA;&#x9;&#x9;&#x9;row.insertCell(4).innerHTML = '';&#xA;&#x9;&#x9;} else { // this is a rule&#xA;&#x9;&#x9;&#x9;if (budgetValues.optionals[i].optional.editor == 'A') {&#xA;&#x9;&#x9;&#x9;&#x9;// TODO: updateMinMaxOptions(getElement('qty' + obj.id), num, 1000000); // cannot be lower than 'num'&#xA;&#x9;&#x9;&#x9;&#x9;continue; // this rule value is in items/services&#xA;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;&#x9;if (lastRow == null || lastRow != budgetValues.optionals[i].rowid) {&#xA;&#x9;&#x9;&#x9;&#x9;row = getElement('tblMainOptions').insertRow(-1);&#xA;&#x9;&#x9;&#x9;&#x9;row.id = budgetValues.optionals[i].rowid;&#xA;&#x9;&#x9;&#x9;&#x9;row.className = 'trH25';&#xA;&#x9;&#x9;&#x9;&#x9;col = 0;&#xA;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;&#x9;row.insertCell(col++).innerHTML = budgetValues.optionals[i].optional.text;&#xA;&#x9;&#x9;&#x9;var txt = '', val = budgetValues.optionals[i].value;&#xA;&#x9;&#x9;&#x9;if (budgetValues.optionals[i].optional.editor == 'S') {&#xA;&#x9;&#x9;&#x9;&#x9;txt = '<select onchange=\'return updateOptions(&amp;#39;' + budgetValues.optionals[i].optional.tag + '&amp;#39;, null, null, this.value);\' name=\'' + budgetValues.optionals[i].optional.tag + '\' id=\'' + budgetValues.optionals[i].optional.tag + '\' class=\'form-item\'&gt;';&#xA;&#x9;&#x9;&#x9;&#x9;var options = budgetValues.optionals[i].optional.values.split(',');&#xA;&#x9;&#x9;&#x9;&#x9;for (var k = 0; k < options.length; k++) txt += '<option value=\'' + options[k].trim() + '\'&gt;' + options[k].trim() + '</option&gt;';&#xA;&#x9;&#x9;&#x9;&#x9;txt += '</select&gt;';&#xA;&#x9;&#x9;&#x9;&#x9;row.insertCell(col++).innerHTML = txt;&#xA;&#x9;&#x9;&#x9;&#x9;getElement(budgetValues.optionals[i].optional.tag).value = budgetValues.optionals[i].value;&#xA;&#x9;&#x9;&#x9;} else {&#xA;&#x9;&#x9;&#x9;&#x9;var txt = '<input onchange=\'return updateOptions(&amp;#39;' + budgetValues.optionals[i].optional.tag + '&amp;#39;, null, null, this.value);\' onkeyup=\'return updateOptions(&amp;#39;' + budgetValues.optionals[i].optional.tag + '&amp;#39;, null, null, this.value);\' type=\'text\'';&#xA;&#x9;&#x9;&#x9;&#x9;if (budgetValues.optionals[i].optional.editor == 'N') txt += ' onkeypress=\'return event.charCode &gt;= 48 &amp;&amp; event.charCode <= 57\'';&#xA;&#x9;&#x9;&#x9;&#x9;txt += ' name=\'' + budgetValues.optionals[i].optional.tag + '\' class=\'form-item\'';&#xA;&#x9;&#x9;&#x9;&#x9;txt += ' value=\'' + val + '\'&gt;';&#xA;&#x9;&#x9;&#x9;&#x9;txt += '</input&gt;';&#xA;&#x9;&#x9;&#x9;&#x9;row.insertCell(col++).innerHTML = txt;&#xA;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;&#x9;if (col < 5) row.insertCell(col++).innerHTML = '';&#xA;&#x9;&#x9;&#x9;lastRow = budgetValues.optionals[i].rowid;&#xA;&#x9;&#x9;}&#xA;&#x9;}&#xA;&#x9;&#xA;} else {&#xA;&#x9;/* TODO: remove .pp */&#xA;&#x9;budgetValues = { mode: 0, pType: 0, &#xA;&#x9;&#x9;products: [], services: [], optionals: [],&#xA;&#x9;&#x9;disc: {item: 0, srv: 0, inst: 0}, &#xA;&#x9;&#x9;totals: {item: 0, srv: 0, inst: 0},&#xA;&#x9;&#x9;installments: {install: 1, products: 1}, &#xA;&#x9;&#x9;grandTotal: 0, totalMonthlyPayment: 0, &#xA;&#x9;&#x9;pp: 1, bj: 1, cs: 1, alarmType: -1, lastTblIdx: 3, uw: 3&#xA;&#x9;};&#xA;&#x9;window['lastTblColIdx'] = 0;&#xA;&#x9;handleProjectType(0, true); // default&#xA;}&#xA;&#xA;applyRules();&#xA;getElement('proposalDiv').style.display='block';&#xA;getElement('createProposalBut').style.display='none';&#xA;return false;&#xA;&#xA;">Elaborar / Alterar Proposta</button><div id="proposalDiv" style="width: 100%; display: none;"><div style="width: 100%; height: 20px;"></div><div style="width: 100%; height: 14px;"></div><div class="group_box"><div class="group_box_title" id="titleOverview"><a onclick="openCloseGroup('divOverview', 'titleOverview');" href="javascript:void(0);" style="text-decoration: none; font-weight: bold; color: #000000;" class=""><div style="padding: 10px; text-decoration: none; width: 98%; text-align: right;"><span id="projectDesc">Projeto Alarme</span></div></a></div><div style="padding-left: 5px; width: 100%; display: none;" id="divOverview"><div style="width: 100%; height: 20px;"></div><table style="border: 0px;" id="tblMainOptions"><tbody><tr class="mainOptionsRow"><td>Modalidade: </td><td><select onchange="return handleMode(this.value);" id="pType" class="form-item"><option value="0">Venda</option><option value="1">Comodato</option></select></td><td style="padding-left: 5px; padding-right: 5px;"></td><td>Instala����o em Hor��rio Comercial: </td><td><select onchange="handleInstallTime(this.value);" id="installTime" class="form-item" style="min-width: 40px; max-width: 200px;"><option value="1">Sim</option><option value="2">N��o</option></select></td></tr><tr class="mainOptionsRow"><td>Tipo de Projeto: </td><td><select onchange="return handleProjectType(this.value, true);" id="projType" class="form-item"></select></td><td style="padding-left: 5px; padding-right: 5px;"></td><td>Grande Obra: </td><td><select onchange="handleBigJob(this.value);" id="bigJob" class="form-item" style="min-width: 40px; max-width: 200px;"><option value="1">N��o</option><option value="2">Sim, inferior a 2000m</option><option value="3">Sim, superior a 2000m</option></select></td></tr><tr class="mainOptionsRow"><td><span id="lblAlarmType" style="display: none;">Tipo de Alarme</span></td><td><div id="divAlarmTypes"></div></td><td style="padding-left: 5px; padding-right: 5px;"></td><td>Local est�� em Obras: </td><td><select onchange="handleUnderWork(this.value);" id="underWork" class="form-item" style="min-width: 40px; max-width: 200px;"><option value="1">N��o</option><option value="2">Parcialmente, os locais das instala����es n��o est��o em obras.</option><option value="3">Sim, passar��o somente cabos, sem libera����o de equipamentos.</option></select></td></tr></tbody></table><div style="width: 100%; height: 20px;"></div></div></div><div style="width: 100%; height: 14px;"></div><div class="group_box"><div class="group_box_title" id="titleItems"><a onclick="openCloseGroup('divItems', 'titleItems');" href="javascript:void(0);" style="text-decoration: none; font-weight: bold; color: #000000;" class=""><div style="padding: 10px; text-decoration: none; width: 98%; text-align: right;">Equipamentos - $<span id="totalItems">0.00</span></div></a></div><div style="padding-left: 5px; width: 100%; display: none;" id="divItems"><div style="width: 100%; height: 20px;"></div><div style="height: 35px; display: inline;"><span style="width: 200px; padding-right: 5px;">Seleccionar Equipamentos: </span><select onchange="document.getElementById('addItemBut').disabled = (this.value.disabled); return false;" id="itemValues" style="min-width: 100px; max-width: 250px;" class="form-item"></select><div style="display: inline; padding-left: 10px;"><button onclick="return addItem(document.getElementById('itemValues').value, null, 'IT');" style="height: 29px; display: inline;" class="button dismiss" id="addItemBut">Adicionar</button></div></div><div style="width: 100%; height: 10px;"></div><table class="item_table" id="tblItems"><thead><tr><th style="width: 40px;">ID</th><th>Equipamento</th><th style="width: 70px;">Movimenta����o</th><th style="width: 70px;">Quantidade</th><th style="width: 70px;">Pre��o</th><th style="width: 70px;">Instala����o</th><th style="width: 70px;">Total</th><th style="width: 70px;"></th></tr></thead><tbody></tbody></table><div style="width: 100%; height: 20px;"></div></div></div><div style="width: 100%; height: 14px;"></div><div class="group_box"><div class="group_box_title" id="titleServices"><a onclick="openCloseGroup('divServices', 'titleServices');" href="javascript:void(0);" style="text-decoration: none; font-weight: bold; color: #000000;" class=""><div style="padding: 10px; text-decoration: none; width: 98%; text-align: right;">Servi��os - $<span id="totalServices">0.00</span></div></a></div><div style="padding-left: 5px; width: 100%; display: none;" id="divServices"><div style="width: 100%; height: 20px;"></div><div style="height: 35px; display: inline; width: 100%;"><span style="width: 200px; padding-right: 5px;">Seleccionar Servi��os: </span><select id="serviceValues" style="min-width: 100px; max-width: 250px;" class="form-item"></select><div style="display: inline; padding-left: 10px;"><button onclick="return addService(document.getElementById('serviceValues').value, null, 'IT');" style="height: 29px; display: inline;" class="button dismiss">Adicionar</button></div></div><div style="width: 100%; height: 10px;"></div><table class="item_table" id="tblServices"><thead><tr><th style="width: 40px;">ID</th><th>Servi��o</th><th style="width: 70px;">Quantidade</th><th style="width: 70px;">Pre��o</th><th style="width: 70px;">Total</th><th style="width: 70px; "></th></tr></thead><tbody></tbody></table><div style="width: 100%; height: 20px;"></div></div></div><div style="width: 100%; height: 14px;"></div><div class="group_box"><div class="group_box_title" id="titleGrandTotal"><a onclick="openCloseGroup('divGrandTotal', 'titleGrandTotal');" href="javascript:void(0);" style="text-decoration: none; font-weight: bold; color: #000000;" class=""><div style="padding: 10px; text-decoration: none; width: 98%; text-align: right;">Total - $<span id="grandTotal">0.00</span></div></a></div><div style="padding-left: 5px; width: 100%; display: none;" id="divGrandTotal"><div style="width: 100%; height: 10px;"></div><table id="totalsTable" style="border: 0;"><tbody><tr class="trH35"><td class="subHeading" colspan="3"><strong>Descontos</strong></td></tr><tr class="trH25"><td>Equipamentos: </td><td><select onchange="handleDiscounts(this.form.itemDiscount, this.form.installDiscount, this.form.serviceDiscount); return false;" id="itemDiscount" style="min-width: 40px; max-width: 80px;" class="form-item"></select></td><td style="padding-left: 10px;">$<span id="totalItemDiscount">0.00 ($0.00)</span></td></tr><tr class="trH25"><td>Instala����o:</td><td><select onchange="handleDiscounts(this.form.itemDiscount, this.form.installDiscount, this.form.serviceDiscount); return false;" id="installDiscount" style="min-width: 40px; max-width: 80px;" class="form-item"></select></td><td style="padding-left: 10px;">$<span id="totalInstallDiscount">0.00 ($0.00)</span></td></tr><tr class="trH25"><td>Servi��os:</td><td><select onchange="handleDiscounts(this.form.itemDiscount, this.form.installDiscount, this.form.serviceDiscount); return false;" id="serviceDiscount" style="min-width: 40px; max-width: 80px;" class="form-item"></select></td><td style="padding-left: 10px;">$<span id="totalServiceDiscount">0.00 ($0.00)</span></td></tr><tr class="trH25"><td>Total Descontos:</td><td><span></span></td><td style="padding-left: 10px;">$<span id="totalDiscount">0.00</span></td></tr><tr class="trH35"><td class="subHeading" colspan="3"><strong>Parcelamento</strong></td></tr><tr id="equipmentInstallmentTR" class="trH25"><td>Equipamentos: </td><td><select onchange="handleInstallments();" id="paymentItemParcels" style="min-width: 40px; max-width: 80px;" class="form-item"></select></td><td style="padding-left: 10px;"><span id="totalParcelItemValue">$0.00 ($0.00)</span></td></tr><tr class="trH25"><td>Instala����o: </td><td><select onchange="handleInstallments();" id="paymentInstallParcels" style="min-width: 40px; max-width: 80px;" class="form-item"></select></td><td style="padding-left: 10px;"><span id="totalParcelInstallValue">$0.00 ($0.00)</span></td></tr><tr class="trH25"><td>Valor da Primeira Parcela: </td><td><span></span></td><td style="padding-left: 10px;">$<span id="totalMonthlyPayment"></span></td></tr><tr class="trH35"><td class="subHeading" colspan="3"><strong>Totais</strong></td></tr><tr class="trH25"><td><div style="display: inline;">Instala����o: </div></td><td><span></span></td><td style="padding-left: 10px;">$<span id="totalInstall">0.00</span><span id="installMarker"></span></td></tr><tr class="trH25"><td><div style="display: inline;"><span id="modality">Venda</span>: </div></td><td><span></span></td><td style="padding-left: 10px;">$<span id="totalSale">0.00</span></td></tr><tr class="trH25"><td><div style="display: inline;">Servi��os: </div></td><td><span></span></td><td style="padding-left: 10px;">$<span id="totalService">0.00</span></td></tr><tr class="trH25"><td style="width: 270px;"><div style="display: inline;">Mensalidade <span id="monthlyDesc">(Servi��os)</span>: </div></td><td><span></span></td><td style="padding-left: 10px;">$<span id="totalMonthly">0.00</span></td></tr><tr style="padding: 5px 0 5px 0; height: 30px; vertical-align: bottom;"><td style="font-size: 10px; vertical-align: bottom;" colspan="3"><span id="totalsNotes"></span></td></tr></tbody></table><div style="width: 100%; height: 10px;"></div></div></div></div></div>
